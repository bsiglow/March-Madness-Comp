---
title: "MarchMaddness"
author: "Benjamin Siglow"
date: "1/19/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
```

```{r}
OG_RegSeasonStat <-  read.csv("https://www.dropbox.com/s/di27y44wsl92dqs/MRegularSeasonDetailedResults.csv?dl=1")

```

```{r}
#str(OG_RegSeasonStat) # will need to merge in rank data from the teams excel doc , currently working on individual team table
teams_pros <-  OG_RegSeasonStat # combining season and team ids to create a team data frame 
teams_pros$WTIDSeason <- paste(teams_pros$Season, teams_pros$WTeamID)
teams_pros$LTIDSeason <-paste(teams_pros$Season, teams_pros$LTeamID)
```

```{r}
teams <-  teams <- as.data.frame(unique(c(teams_pros$LTIDSeason, teams_pros$WTIDSeason)))
colnames(teams)[1] <-  "TeamID"
```

```{r :: Creating winning team data frame}
#teams_prossmall <-  teams_pros[1:10,] # small data frame to confirm cleaning
#a_teams_prossmall <-  teams_prossmall[,-36] # Removing Losing team info (Smallframe)
a_teams_pros <-  teams_pros[,-36] # Removing Losing team info 
a_teams_pros$Score_diff <-  a_teams_pros$WScore - a_teams_pros$LScore # Creating score differenctial
a_teams_pros <-  a_teams_pros[,grep(pattern = "L", colnames(a_teams_pros),ignore.case = FALSE , invert = TRUE)] # Removing all columns relating to losing team 
colnames(a_teams_pros)[19] <- "Team" # Row name change
colCleanW <- function(x){ colnames(x) <- gsub("W", "", colnames(x)); x }  # Removing all prefix W in colnames
a_teams_pros <-  colCleanW(a_teams_pros) # Running function
a_teams_pros <-  a_teams_pros[,-c(1:3)] # Removing redundant columns, can be removed to spot check 
```


```{r :: Creating only loser data}
b_teams_pros <-  teams_pros[,-35] # Removing Winning team info 
b_teams_pros$Score_diff <-  b_teams_pros$LScore - b_teams_pros$WScore # Creating score differential
b_teams_pros <-  b_teams_pros[,grep(pattern = "W", colnames(b_teams_pros),ignore.case = FALSE , invert = TRUE)] # Removing all columns relating to losing team 
colnames(b_teams_pros)[19] <- "Team" # Row name change
colCleanW <- function(x){ colnames(x) <- gsub("L", "", colnames(x)); x }  # Removing all prefix W in colnames
b_teams_pros <-  colCleanW(b_teams_pros) # Running function
b_teams_pros <-  b_teams_pros[,-c(1:3)] # Removing redundant columns, can be removed to spot check
```

```{r :: Creating win loss column}
#teams_small_a <-  rbind(a_teams_prossmall,b_teams_prossmall) # creating winning and losing team stats in small format
teams_all <-  rbind(a_teams_pros, b_teams_pros) # Creating team Data Frame

teams_all$W_L <-  as.numeric(teams_all$Score_diff > 0) # Creating win loss column 
```

```{r :: Loop to create each year/team results}
res <-  as.data.frame(matrix(NA, nrow = nrow(teams), ncol = 25))
                      
for (i in 1:nrow(teams)){
  temp <- teams_all[teams_all$Team == teams$TeamID[i], ]
  res[i,1] <- temp$Team[i]
  res[i, 2] <-  sum(temp$FGM)/sum(temp$FGA) 
  res[i,3] <- mean(temp$Score)
  res[i,4] <- mean(temp$NumOT)
  res[i, 5] <- mean(temp$FGA)
  res[i, 6] <- sum(temp$FGM3)/sum(temp$FGA3)
  res[i,7] <- mean(temp$FGA3)
  res[i, 8] <- sum(temp$FTM)/sum(temp$FTA)
  res[i, 9] <-  mean(temp$FTA)
  res[i, 10] <- mean(temp$OR)
  res[i, 11] <- mean(temp$DR)
  res[i, 12] <- mean(temp$Ast)
  res[i, 13] <- mean(temp$TO)
  res[i, 14] <- mean(temp$Stl)
  res[i, 15] <- mean(temp$Blk)
  res[i, 16] <- mean(temp$PF)
  res[i, 17] <- mean(temp$Score_diff)
  res[i, 18] <- sum(temp$W_L)
  res[i, 19] <- length(temp$Score) - sum(temp$W_L)
  res[i, 20] <- sum(temp$FGA - temp$FGA3)/sum(temp$FGA3)
  
}

names(res) <-  c("TeamID_Year", "FG_Prec", "Avg_Score","AVG_OT", "Avg_FGA", "FG3_Prec", "Avg_FGA3", "FT_Prec", "AVG_FTA", "AVG_OR", "AVG_DR", "AVG_AST", "ACG_TO", "AvG_Stl", "AVG_Blk", "AVG_PF", "AVG_Scor_Diff", "Num_Wins","Num_Loss","2pt_3pt_ratio" , "Avg_Rank", "Best_Rank", "Final_Rank")

#head(res)

teams_all1 <-  res
```

```{r}
rank_table <-  read.csv("https://www.dropbox.com/s/fi3m97x6424qjrb/MMasseyOrdinals.csv?dl=1")

rank_test <- rank_table


#der <-  rank_test %>%
 # filter((Season == 2013) & (TeamID == 1104))
#head(der)

#min(der$OrdinalRank)

#length(unique(rank_test$SystemName))

#unique(rank_test$SystemName)
```

```{r}
rank_test$TeamID_Year <-  paste(rank_table$Season, rank_table$TeamID)

```


```{r :: loop check}

rank_test_small <-  rank_test[1:1000,]
teams_all1_small <- teams_all1[1:1000,]


check_finalrank_value <-  rank_test_small$OrdinalRank[rank_test_small$RankingDayNum == max(rank_test_small$RankingDayNum)] # Checking if this results in the correct value for Final_Rank

# We cannot have a final ranking, because we do not have one final day ranking, we will need to review using specific ranking columns or other processing. 

check_rank_values <-  rank_test_small %>%
  filter(TeamID_Year == "2003 1328") %>%
  select(c(OrdinalRank , RankingDayNum)) %>%
  as.data.frame()
check_rank_values # Checking if we determine the best rank




for (i in 1:nrow(teams_all1_small)){
  temp <- rank_test_small[rank_test_small$TeamID_Year == teams_all1_small$TeamID_Year[i], ]
  teams_all1_small[i,21] <- mean(temp$OrdinalRank)
  teams_all1_small[i,22] <- min(temp$OrdinalRank)
  
}


```



```{r :: Do not run following loop to combine data if you do not need to}
for (i in 1:nrow(teams_all1)){
  temp <- rank_test[rank_test$TeamID_Year == teams_all1$TeamID_Year[i], ]
  teams_all1[i,21] <- mean(temp$OrdinalRank)
  teams_all1[i,22] <- min(temp$OrdinalRank)
}

# Saving to csv, however could also add mode and median of rank or create chart of each ranking conglomerant 
```

```{r}
getwd()
Teams_rank <-  teams_all1
write.csv(teams_all1, file = "Teams_Table")
```


```{r}
check_rank_values_all <-  rank_test %>%
  filter(TeamID_Year == "2003 1328") %>%
  select(c(OrdinalRank , RankingDayNum)) %>%
  as.data.frame()
check_rank_values_all
```

```{r}
Team_table_csv <-  read.csv("https://www.dropbox.com/s/6m119xdn1z5ysqc/Teams_Table?dl=1") # Read in of final team table so no need to use long loop. 

summary(Team_table_csv) # Created 5807 NA values through the loop. This will need to be reviewed. 
summary(rank_table)
```

