---
title: "Function prep"
author: "Benjamin Siglow"
date: "2/6/2021"
output: html_document
---

```{r :: Load packages}
library(devtools)
library(xgboostExplainer)
library(tidyverse)
library(ggdark)
library(rattle)	
library(RColorBrewer)
library(randomForest)
library(caTools)
library(caret)
library(rpart)
library(splitstackshape)
library(xgboost)
library(Metrics)
library(pROC)
library(SHAPforxgboost)
library(xgboostExplainer)
library(OptimalCutpoints)

```


```{r :: Load in files}
Tourney_base <- read.csv("https://www.dropbox.com/s/zhb810pe94bd8ik/Tourney_base_table?dl=1")
load(url("https://www.dropbox.com/s/jk3kfm9irxawt90/Tourney_2017_stats?dl=1"))
load(url("https://www.dropbox.com/s/jr2hvn018s9df8j/Tourney_2017_64?dl=1"))
Gamebeast <-  xgb.load("small_test_xgmodel")

```


```{r :: bind Tourney_base and Tourney seeds from data}
# think about re-creating xg model with final rank diff

```

```{r :: Function to predict play in games}

```

```{r :: Tata edit}
TM <- Tourn_2017_64[,1:9]
Tourn_2017_64 <-  TM # need to resave the file to remove the results columns, fixing here for testing.
```

```{r :: colnames}
names <- c("RFG_Prec","RAvg_Score","RAVG_OT","RAvg_FGA","RFG3_Prec","RAvg_FGA3"   ,"RFT_Prec","RAVG_FTA","RAVG_OR","RAVG_DR","RAVG_AST","RAvG_TO","RAvG_Stl",        "RAVG_Blk","RAVG_PF","RAVG_Scor_Diff","RX2pt_3pt_ratio","RAvg_Rank","RBest_Rank",      "RFinal_NET_Rank","RFinal_AP_Rank","RWorst_AP_Rank","OFG_Prec","OAvg_Score","OAVG_OT",         "OAvg_FGA", "OFG3_Prec","OAvg_FGA3","OFT_Prec","OAVG_FTA","OAVG_OR",         "OAVG_DR","OAVG_AST","OAvG_TO","OAvG_Stl","OAVG_Blk","OAVG_PF","OAVG_Scor_Diff",  "OX2pt_3pt_ratio", "OAvg_Rank","OBest_Rank","OFinal_NET_Rank","OFinal_AP_Rank" )

```


```{r :: Tourney function}
Tourn_sim <- function(Tourn_2017_64,Tourn_2017_stats,Gamebeast, names)
{
  ######### Game 1 predictions for Round 2 competiiton ##################################################################################################################################################################################
  
round2 <-  rep(NA, 64)


for (i in 1:64){
  teams <-  Tourn_2017_64$TeamID_Year[which(Tourn_2017_64$Game == i)]
  stats1 <-  Tourn_2017_stats[Tourn_2017_stats$TeamID_Year == teams[1],]
  stats2 <-  Tourn_2017_stats[Tourn_2017_stats$TeamID_Year == teams[2],] # How do yu determine the opponent ?
  names(stats1) <- paste("R", names(stats1), sep = "")
  names(stats2) <-  paste("O", names(stats2), sep = "")
  temp_data <-  cbind.data.frame(stats1, stats2)
  # recreat rank diffs in a stats 1 - stats 2
  # Only feed in original XGboost model to create 
  temp_data2 <- xgb.DMatrix(data = as.matrix(temp_data[, names]))
  pred <-  predict(Gamebeast, temp_data2)
  sim <- runif(1, min = 0, max = 1)
  if (pred < sim){
    round2[which(Tourn_2017_64$TeamID_Year == teams[2])] <-  Tourn_2017_64$Game2[which(Tourn_2017_64$TeamID_Year == teams[2])] # assign round 2 game to team 2 if they were to win the game
    
    
  }
  else{
    round2[which(Tourn_2017_64$TeamID_Year == teams[1])] <- Tourn_2017_64$Game2[which(Tourn_2017_64$TeamID_Year == teams[1])]
  }
}

sum(!(is.na(round2)))
Tourn_2017_64 <- cbind(Tourn_2017_64, round2)

round3 <-  rep(NA, 64)


for (i in 1:64){
  teams <-  Tourn_2017_64$TeamID_Year[which(Tourn_2017_64$round2 == i)]
  stats1 <-  Tourn_2017_stats[Tourn_2017_stats$TeamID_Year == teams[1],]
  stats2 <-  Tourn_2017_stats[Tourn_2017_stats$TeamID_Year == teams[2],] # How do yu determine the opponent ?
  names(stats1) <- paste("R", names(stats1), sep = "")
  names(stats2) <-  paste("O", names(stats2), sep = "")
  temp_data <-  cbind.data.frame(stats1, stats2)
  # recreat rank diffs in a stats 1 - stats 2
  # Only feed in original XGboost model to create 
  temp_data2 <- xgb.DMatrix(data = as.matrix(temp_data[, names]))
  pred <-  predict(Gamebeast, temp_data2)
  sim <- runif(1, min = 0, max = 1)
  if (pred < sim){
    round3[which(Tourn_2017_64$TeamID_Year == teams[2])] <-  Tourn_2017_64$Game3[which(Tourn_2017_64$TeamID_Year == teams[2])] # assign round 2 game to team 2 if they were to win the game
    
    
  }
  else{
    round3[which(Tourn_2017_64$TeamID_Year == teams[1])] <- Tourn_2017_64$Game3[which(Tourn_2017_64$TeamID_Year == teams[1])]
  }
}

sum(!(is.na(round3)))
Tourn_2017_64 <- cbind(Tourn_2017_64, round3)

round4 <-  rep(NA, 64)


for (i in 1:64){
  teams <-  Tourn_2017_64$TeamID_Year[which(Tourn_2017_64$round3 == i)]
  stats1 <-  Tourn_2017_stats[Tourn_2017_stats$TeamID_Year == teams[1],]
  stats2 <-  Tourn_2017_stats[Tourn_2017_stats$TeamID_Year == teams[2],] # How do yu determine the opponent ?
  names(stats1) <- paste("R", names(stats1), sep = "")
  names(stats2) <-  paste("O", names(stats2), sep = "")
  temp_data <-  cbind.data.frame(stats1, stats2)
  # recreat rank diffs in a stats 1 - stats 2
  # Only feed in original XGboost model to create 
  temp_data2 <- xgb.DMatrix(data = as.matrix(temp_data[, names]))
  pred <-  predict(Gamebeast, temp_data2)
  sim <- runif(1, min = 0, max = 1)
  if (pred < sim){
    round4[which(Tourn_2017_64$TeamID_Year == teams[2])] <-  Tourn_2017_64$Game4[which(Tourn_2017_64$TeamID_Year == teams[2])] # assign round 2 game to team 2 if they were to win the game
    
    
  }
  else{
    round4[which(Tourn_2017_64$TeamID_Year == teams[1])] <- Tourn_2017_64$Game4[which(Tourn_2017_64$TeamID_Year == teams[1])]
  }
}

sum(!(is.na(round4)))
Tourn_2017_64 <- cbind(Tourn_2017_64, round4)


round5 <-  rep(NA, 64)


for (i in 1:64){
  teams <-  Tourn_2017_64$TeamID_Year[which(Tourn_2017_64$round4 == i)]
  stats1 <-  Tourn_2017_stats[Tourn_2017_stats$TeamID_Year == teams[1],]
  stats2 <-  Tourn_2017_stats[Tourn_2017_stats$TeamID_Year == teams[2],] # How do yu determine the opponent ?
  names(stats1) <- paste("R", names(stats1), sep = "")
  names(stats2) <-  paste("O", names(stats2), sep = "")
  temp_data <-  cbind.data.frame(stats1, stats2)
  # recreat rank diffs in a stats 1 - stats 2
  # Only feed in original XGboost model to create 
  temp_data2 <- xgb.DMatrix(data = as.matrix(temp_data[, names]))
  pred <-  predict(Gamebeast, temp_data2)
  sim <- runif(1, min = 0, max = 1)
  if (pred < sim){
    round5[which(Tourn_2017_64$TeamID_Year == teams[2])] <-  Tourn_2017_64$Game5[which(Tourn_2017_64$TeamID_Year == teams[2])] # assign round 2 game to team 2 if they were to win the game
    
    
  }
  else{
    round5[which(Tourn_2017_64$TeamID_Year == teams[1])] <- Tourn_2017_64$Game5[which(Tourn_2017_64$TeamID_Year == teams[1])]
  }
}

sum(!(is.na(round5)))
Tourn_2017_64 <- cbind(Tourn_2017_64, round5)

round6 <-  rep(NA, 64)


for (i in 1:64){
  teams <-  Tourn_2017_64$TeamID_Year[which(Tourn_2017_64$round5 == i)]
  stats1 <-  Tourn_2017_stats[Tourn_2017_stats$TeamID_Year == teams[1],]
  stats2 <-  Tourn_2017_stats[Tourn_2017_stats$TeamID_Year == teams[2],] # How do yu determine the opponent ?
  names(stats1) <- paste("R", names(stats1), sep = "")
  names(stats2) <-  paste("O", names(stats2), sep = "")
  temp_data <-  cbind.data.frame(stats1, stats2)
  # recreat rank diffs in a stats 1 - stats 2
  # Only feed in original XGboost model to create 
  temp_data2 <- xgb.DMatrix(data = as.matrix(temp_data[, names]))
  pred <-  predict(Gamebeast, temp_data2)
  sim <- runif(1, min = 0, max = 1)
  if (pred < sim){
    round6[which(Tourn_2017_64$TeamID_Year == teams[2])] <-  Tourn_2017_64$Game6[which(Tourn_2017_64$TeamID_Year == teams[2])] # assign round 2 game to team 2 if they were to win the game
    
    
  }
  else{
    round6[which(Tourn_2017_64$TeamID_Year == teams[1])] <- Tourn_2017_64$Game6[which(Tourn_2017_64$TeamID_Year == teams[1])]
  }
}

sum(!(is.na(round6)))
Tourn_2017_64 <- cbind(Tourn_2017_64, round6)

champ <-  rep(NA, 64)


for (i in 1:64){
  teams <-  Tourn_2017_64$TeamID_Year[which(Tourn_2017_64$round6 == i)]
  stats1 <-  Tourn_2017_stats[Tourn_2017_stats$TeamID_Year == teams[1],]
  stats2 <-  Tourn_2017_stats[Tourn_2017_stats$TeamID_Year == teams[2],] # How do yu determine the opponent ?
  names(stats1) <- paste("R", names(stats1), sep = "")
  names(stats2) <-  paste("O", names(stats2), sep = "")
  temp_data <-  cbind.data.frame(stats1, stats2)
  # recreat rank diffs in a stats 1 - stats 2
  # Only feed in original XGboost model to create 
  temp_data2 <- xgb.DMatrix(data = as.matrix(temp_data[, names]))
  pred <-  predict(Gamebeast, temp_data2)
  sim <- runif(1, min = 0, max = 1)
  if (pred < sim){
    champ[which(Tourn_2017_64$TeamID_Year == teams[2])] <-  Tourn_2017_64$Game6[which(Tourn_2017_64$TeamID_Year == teams[2])] # assign round 2 game to team 2 if they were to win the game
    
    
  }
  else{
    champ[which(Tourn_2017_64$TeamID_Year == teams[1])] <- Tourn_2017_64$Game6[which(Tourn_2017_64$TeamID_Year == teams[1])]
  }
}

sum(!(is.na(champ)))
Tourn_2017_64 <- cbind(Tourn_2017_64, champ)

}
```

```{r :: Re_run sim 100 times}

Final_four <- rep(NA, 64)
# For 1 to 10,000
for(x in 1:5){
  # Set seed for reproducability
  set.seed(x)
  # Simulate tournament
  temp <- Tourn_sim(Tourn_2017_64 = Tourn_2017_64, Tourn_2017_stats = Tourn_2017_stats, Gamebeast = Gamebeast, names = names)
  # Extract tournament winner
  Final_four[x] <- temp$TeamID_Year[which(!is.na(temp$round5))]
}

final_four_count <- as.data.frame(table(Final_four))
# Print out tabulated results
final_four_count

# This does not pull the championship game. 


```


```{r}
winner <- rep(NA, 100)
# For 1 to 10,000
for(x in 1:100){
  # Set seed for reproducability
  set.seed(x)
  # Simulate tournament
  temp <- Tourn_sim(Tourn_2017_64 = Tourn_2017_64, Tourn_2017_stats = Tourn_2017_stats, Gamebeast = Gamebeast, names = names)
  # Extract tournament winner
  winner[x] <- temp$TeamID_Year[which(temp$champ == 1)]
}

champ_count <- as.data.frame(table(winner))
# Print out tabulated results
champ_count
```

